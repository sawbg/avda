\hypertarget{main_8cpp}{\section{src/main.cpp File Reference}
\label{main_8cpp}\index{src/main.\+cpp@{src/main.\+cpp}}
}


Contains the main program.  


{\ttfamily \#include $<$array$>$}\\*
{\ttfamily \#include $<$cstdio$>$}\\*
{\ttfamily \#include $<$cstdlib$>$}\\*
{\ttfamily \#include $<$fcntl.\+h$>$}\\*
{\ttfamily \#include $<$iostream$>$}\\*
{\ttfamily \#include $<$map$>$}\\*
{\ttfamily \#include $<$pthread.\+h$>$}\\*
{\ttfamily \#include $<$string$>$}\\*
{\ttfamily \#include $<$unistd.\+h$>$}\\*
{\ttfamily \#include \char`\"{}definitions.\+hpp\char`\"{}}\\*
{\ttfamily \#include \char`\"{}fileio.\+hpp\char`\"{}}\\*
{\ttfamily \#include \char`\"{}process.\+hpp\char`\"{}}\\*
Include dependency graph for main.\+cpp\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{main_8cpp__incl}
\end{center}
\end{figure}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
int \hyperlink{main_8cpp_a3c04138a5bfe5d72780bb7e82a18e627}{main} (int argc, char $\ast$$\ast$argv)
\end{DoxyCompactItemize}


\subsection{Detailed Description}
Contains the main program. 

\begin{DoxyAuthor}{Author}
Samuel Andrew Wisner, \href{mailto:awisner94@gmail.com}{\tt awisner94@gmail.\+com} 
\end{DoxyAuthor}
\begin{DoxyRefDesc}{Bug}
\item[\hyperlink{bug__bug000002}{Bug}]extra newline character inserted into stdin buffer after \hyperlink{namespaceavda_ae20728e7e8ae50bf2f74849e538841ea}{Patient\+Name()} is run \end{DoxyRefDesc}


Definition in file \hyperlink{main_8cpp_source}{main.\+cpp}.



\subsection{Function Documentation}
\hypertarget{main_8cpp_a3c04138a5bfe5d72780bb7e82a18e627}{\index{main.\+cpp@{main.\+cpp}!main@{main}}
\index{main@{main}!main.\+cpp@{main.\+cpp}}
\subsubsection[{main}]{\setlength{\rightskip}{0pt plus 5cm}int main (
\begin{DoxyParamCaption}
\item[{int}]{argc, }
\item[{char $\ast$$\ast$}]{argv}
\end{DoxyParamCaption}
)}}\label{main_8cpp_a3c04138a5bfe5d72780bb7e82a18e627}
The main program for this project. It will detect avdaspasms over a period of days. 

Definition at line \hyperlink{main_8cpp_source_l00030}{30} of file \hyperlink{main_8cpp_source}{main.\+cpp}.


\begin{DoxyCode}
00030                                 \{
00031     \textcolor{comment}{// Recorded audio buffer}
00032     \hyperlink{definitions_8hpp_aacdc525d6f7bddb3ae95d5c311bd06a1}{float32}* buffer = (\hyperlink{definitions_8hpp_aacdc525d6f7bddb3ae95d5c311bd06a1}{float32}*)std::malloc(\hyperlink{definitions_8hpp_aca681ed285767aaa2353bf3b42dd60ed}{BUFFER\_SIZE});
00033     \textcolor{keywordtype}{bool} cont = \textcolor{keyword}{true};  \textcolor{comment}{// whether to continue in the recording loop}
00034     \hyperlink{structDataParams}{DataParams} params[\hyperlink{definitions_8hpp_a2fd18fd694a2918f7d73eba821fd10b2}{REC\_COUNT}];  \textcolor{comment}{// holds DataParam's from recordings}
00035     \textcolor{keywordtype}{string} filename = \hyperlink{namespaceavda_ae20728e7e8ae50bf2f74849e538841ea}{PatientName}();  \textcolor{comment}{// generate name for patient's file}
00036     map<Side, DataParams> results;  \textcolor{comment}{// parameters by side}
00037 
00038     \textcolor{comment}{// arecord command}
00039     \textcolor{keyword}{const} \textcolor{keywordtype}{string} recCommand = string(\textcolor{stringliteral}{"arecord -t raw -d "})
00040         + to\_string(\hyperlink{definitions_8hpp_ada7a88c013312e76596a2000cc8277fb}{DURATION}) + string(\textcolor{stringliteral}{" -D plughw:1,0 -f FLOAT -q -r "})
00041         + to\_string(\hyperlink{definitions_8hpp_a8ace559345ecba7978591ac2ef22aea4}{SAMPLE\_FREQ}) + string(\textcolor{stringliteral}{" "}) + \hyperlink{definitions_8hpp_a88f32e97c41b89ff0705d0a0b8566b41}{TEMP\_FILE};
00042 
00043     \textcolor{comment}{// Recording}
00044     \textcolor{keywordflow}{while}(cont) \{
00045         \textcolor{keywordflow}{for}(\hyperlink{definitions_8hpp_adde6aaee8457bee49c2a92621fe22b79}{uint8} i = 0; i < \hyperlink{definitions_8hpp_a2fd18fd694a2918f7d73eba821fd10b2}{REC\_COUNT}; i++) \{
00046             \textcolor{comment}{// prompt}
00047             cout << \textcolor{stringliteral}{"Press [ ENTER ] to begin analysis for the "}
00048                 << (i < REC\_COUNT / 2 ? \textcolor{stringliteral}{"left"} : \textcolor{stringliteral}{"right"}) << \textcolor{stringliteral}{" side, depth #"}
00049                 << (((i >= REC\_COUNT / 2) ? (i - REC\_COUNT / 2) : i) + 1)
00050                 << \textcolor{stringliteral}{" "};
00051             getchar();  \textcolor{comment}{// wait for ENTER to be pressed}
00052             cout << \textcolor{stringliteral}{"Analyzing..."} << endl;
00053 
00054             system(recCommand.c\_str());
00055             usleep(\hyperlink{definitions_8hpp_ada7a88c013312e76596a2000cc8277fb}{DURATION}*1000000 + 1500000);  \textcolor{comment}{// sleep DURATION + 1.5 seconds}
00056 
00057             \textcolor{keywordtype}{int} file = open(\hyperlink{definitions_8hpp_a88f32e97c41b89ff0705d0a0b8566b41}{TEMP\_FILE}.c\_str(), O\_RDONLY);  \textcolor{comment}{// open temp file}
00058             \textcolor{keywordtype}{int} retRead = read(file, buffer, \hyperlink{definitions_8hpp_aca681ed285767aaa2353bf3b42dd60ed}{BUFFER\_SIZE});  \textcolor{comment}{// copy to buffer}
00059             close(file);  \textcolor{comment}{// close temp file}
00060             \textcolor{keyword}{remove}(\hyperlink{definitions_8hpp_a88f32e97c41b89ff0705d0a0b8566b41}{TEMP\_FILE}.c\_str());  \textcolor{comment}{// delete temp file}
00061 
00062             \textcolor{comment}{// if something goes wrong reading the temp file, program exits}
00063             \textcolor{keywordflow}{if}(file < 0 || retRead < \hyperlink{definitions_8hpp_aca681ed285767aaa2353bf3b42dd60ed}{BUFFER\_SIZE}) \{
00064                 cerr << \textcolor{stringliteral}{"An error occurred reading the doppler audio! "}
00065                     \textcolor{stringliteral}{"The program will now exit."} << endl;
00066                 \textcolor{keywordflow}{return} \hyperlink{definitions_8hpp_a876fcacb67d51738e846a3312dc08fbb}{ERROR};
00067             \}
00068 
00069             \textcolor{comment}{// process and store parameters}
00070             params[i] = \hyperlink{namespaceavda_a5196cce27286d08ca144a460caee7839}{process}(buffer, \hyperlink{definitions_8hpp_ad3af99f5e7cbf2af51be580e91faa934}{SAMPLE\_COUNT}, 
      \hyperlink{definitions_8hpp_a8ace559345ecba7978591ac2ef22aea4}{SAMPLE\_FREQ});
00071             cout << \textcolor{stringliteral}{"The analysis is complete."} << endl << endl;
00072         \}
00073 
00074         \textcolor{comment}{// calculate averaged parameters}
00075         results[Side::Left] = \hyperlink{namespaceavda_a2a830f24a59aa2538ea82f6e000cce61}{average}(params, REC\_COUNT / 2);
00076         results[Side::Right] = \hyperlink{namespaceavda_a2a830f24a59aa2538ea82f6e000cce61}{average}(&params[REC\_COUNT / 2], REC\_COUNT / 2);
00077 
00078         cout << \textcolor{stringliteral}{"Analysis is complete."} << endl << endl;
00079 
00080         \textcolor{comment}{// print averaged side analysis}
00081         \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} i = 0; i < 2; i++) \{
00082             \hyperlink{namespaceavda_af723e82f0d3d45fda6fdc01f6a492786}{Side} side = (\hyperlink{namespaceavda_af723e82f0d3d45fda6fdc01f6a492786}{Side})i;
00083             cout << (side == Side::Left ? \textcolor{stringliteral}{"[LEFT]"} : \textcolor{stringliteral}{"[RIGHT]"}) << endl;
00084             cout << \textcolor{stringliteral}{"Drop-off frequency: "} << (\hyperlink{definitions_8hpp_a05f6b0ae8f6a6e135b0e290c25fe0e4e}{uint16})(results[side].freq + 0.5)
00085                 << \textcolor{stringliteral}{" Hz"} << endl;
00086             cout << \textcolor{stringliteral}{"Average relative noiseband power: "}
00087                 << (\hyperlink{definitions_8hpp_a74df79fde3c518e55b29ce6360a9c76e}{sint16})(results[side].noise - 0.5) << \textcolor{stringliteral}{" dB"} << endl <<endl;
00088         \}
00089 
00090         cont = results[Side::Left].freq > \hyperlink{definitions_8hpp_ab506614aee9be52f401d8d573a8d172c}{MAX\_DROP\_FREQ}
00091             || results[Side::Right].freq > \hyperlink{definitions_8hpp_ab506614aee9be52f401d8d573a8d172c}{MAX\_DROP\_FREQ};
00092 
00093         \textcolor{keywordflow}{if}(cont) \{
00094             cout << \textcolor{stringliteral}{"An error in aquisition of the doppler audio has occurred! "}
00095                 \textcolor{stringliteral}{"Ensure the connection from the doppler machine to this device "}
00096                 \textcolor{stringliteral}{"is secure and the connection uninterruptable."} << endl << endl;
00097         \}
00098     \}
00099 
00100     free(buffer);  \textcolor{comment}{// free buffer to prevent memory leak}
00101     \hyperlink{namespaceavda_a1e3f5a0eb4ee9a7010d57dc38bd8dfec}{WriteParams}(results, filename);
00102 
00103     \textcolor{comment}{// examine likelihood of avdaspasm}
00104     \textcolor{keywordflow}{try} \{
00105         map<Side, DataParams> baseParams = \hyperlink{namespaceavda_a46dc980b65ddfc24749ce25c1290e158}{ReadParams}(filename);
00106         map<Side, bool> comparison;
00107 
00108         \textcolor{keywordflow}{for}(\hyperlink{definitions_8hpp_adde6aaee8457bee49c2a92621fe22b79}{uint8} i = 0; i < 2; i++) \{
00109             \hyperlink{namespaceavda_af723e82f0d3d45fda6fdc01f6a492786}{Side} side = (\hyperlink{namespaceavda_af723e82f0d3d45fda6fdc01f6a492786}{Side})i;
00110             \textcolor{keywordtype}{float} comp = fabs(results[side].freq - baseParams[side].freq) 
00111                 * fabs(baseParams[side].noise - results[side].noise);
00112             comparison[side] = comp > \hyperlink{definitions_8hpp_aa15adfcc96559f1b86210d217edd3afc}{DET\_THRESH};
00113         \}
00114 
00115         \textcolor{keywordtype}{string} which;
00116 
00117         \textcolor{keywordflow}{if}(comparison[Side::Left] && !comparison[Side::Right]) \{
00118             which = \textcolor{stringliteral}{"The left"};
00119         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(!comparison[Side::Left] && comparison[Side::Right]) \{
00120             which = \textcolor{stringliteral}{"The right"};
00121         \} \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (comparison[Side::Left] && comparison[Side::Right]) \{
00122             which = \textcolor{stringliteral}{"Both"};
00123         \} \textcolor{keywordflow}{else} \{
00124             which = \textcolor{stringliteral}{"Neither"};
00125         \}
00126 
00127         cout << which << \textcolor{stringliteral}{" side seems to show evidence of a vasospasm."} << endl;
00128     \} \textcolor{keywordflow}{catch}(runtime\_error ex) \{
00129         cout << \textcolor{stringliteral}{"These values will be stored as the baseline parameters to "}
00130             \textcolor{stringliteral}{"which all future parameters are compared."} << endl;
00131     \}
00132 \}
\end{DoxyCode}


Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{main_8cpp_a3c04138a5bfe5d72780bb7e82a18e627_cgraph}
\end{center}
\end{figure}


